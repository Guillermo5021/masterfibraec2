<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carrito | Master Fibra</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html"><img src="images/logo.webp" height="56" alt=""></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="shop.html">Tienda</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contacto</a></li>
        <li class="nav-item ms-lg-3"><a class="btn btn-outline-primary position-relative" href="cart.html">üõí <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary">0</span></a></li>
      </ul>
    </div>
  </div>
</header>

<section class="container py-4">
  <h1 class="h3 text-primary mb-3">Carrito de compras</h1>
  <div class="row g-4">
    <div class="col-lg-7">
      <div id="cartTable"></div>
    </div>
    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Datos para facturaci√≥n / env√≠o</h5>
          <form id="checkoutForm" class="row g-3">
            <div class="col-12"><input class="form-control" id="name" placeholder="Nombre y apellido" required></div>
            <div class="col-12"><input class="form-control" id="email" placeholder="Correo electr√≥nico" type="email" required></div>
            <div class="col-md-6"><input class="form-control" id="idnum" placeholder="C√©dula/RUC"></div>
            <div class="col-md-6"><input class="form-control" id="phone" placeholder="Tel√©fono" value="+593 98 441 3924"></div>
            <div class="col-12"><input class="form-control" id="address" placeholder="Direcci√≥n"></div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit">Proceder al pago</button>
            </div>
            <small class="text-muted">Se abrir√° PayPal con el total. Tambi√©n puedes enviarnos el pedido por WhatsApp.</small>
          </form>
          <div class="d-grid gap-2 mt-3">
            <button id="btnWA" class="btn btn-success">Enviar pedido por WhatsApp</button>
            <button id="btnClear" class="btn btn-outline-danger">Vaciar carrito</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ‚úÖ Modal de confirmaci√≥n -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‚úÖ Pedido completado</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center p-4">
        <p id="orderModalMsg">Tu pedido ha sido registrado correctamente.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a href="index.html" class="btn btn-success">Ir al inicio</a>
      </div>
    </div>
  </div>
</div>

<footer class="text-center py-4 text-white" style="background-color:#004E7C">
  ¬© 2025 Master Fibra de Vidrio ‚Äì Sitio desarrollado por Ing. Elvis G√≥mez
</footer>

<!-- üî• Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB5OQhX5_Uu3lunMBxc0qQL4yHhe-vdXzA",
    authDomain: "masterfibraec.firebaseapp.com",
    projectId: "masterfibraec",
    storageBucket: "masterfibraec.firebasestorage.app",
    messagingSenderId: "568089252571",
    appId: "1:568089252571:web:db36ba765eaa45029c32fe"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.saveOrderToFirebase = async (pedido)=>{
    try{
      await addDoc(collection(db, "orders"), pedido);
      console.log("‚úÖ Pedido guardado en Firestore");
      return true;
    }catch(e){
      console.error("‚ùå Error al guardar pedido:", e);
      return false;
    }
  };
</script>

<!-- ‚úâÔ∏è EmailJS (versi√≥n correcta v3) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  // Inicializar EmailJS con tu Public Key
  (function() {
    emailjs.init("dEHEg7mWdrFo5jAl"); // Tu clave p√∫blica correcta
  })();

  // Funci√≥n global para env√≠o de correos
  window.sendEmailNotification = async (pedido) => {
    const SERVICE_ID = "service_xx3pjvi";
    const TEMPLATE_EMPRESA = "template_4vowhd8";
    const TEMPLATE_CLIENTE = "template_tz4xxnd";

    try {
      // Enviar correo a la empresa
      await emailjs.send(SERVICE_ID, TEMPLATE_EMPRESA, {
        to_name: pedido.name,
        order_total: pedido.total,
        order_summary: pedido.cart.map(i => `${i.name} x${i.qty} - $${i.price * i.qty}`).join(", "),
        email: pedido.email
      });

      // Enviar copia al cliente
      await emailjs.send(SERVICE_ID, TEMPLATE_CLIENTE, {
        to_name: pedido.name,
        order_id: new Date().getTime(),
        email: pedido.email
      });

      console.log("‚úÖ Correos enviados correctamente con EmailJS");
      return true;
    } catch (error) {
      console.error("‚ùå Error al enviar correos con EmailJS:", error);
      return false;
    }
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="products.js"></script>
<script src="main.js"></script>
<script>
  renderCartTable();
</script>

</body>
</html>